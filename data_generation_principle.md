# 数据生成原理与规则详解

## 概述

本文档详细描述了ToyUSDataset中1D超声信号到2D缺陷图映射的数据生成原理。该数据集模拟了脉冲回波超声检测的基本物理过程，为跨模态学习提供了一个简化但具有代表性的数据源。

## 1. 整体生成流程

```
缺陷位置生成 → 2D缺陷图构建 → 1D超声信号合成 → 噪声添加 → 数据归一化
```

数据生成遵循物理因果关系：缺陷的空间分布决定了超声信号的时域特征。

## 2. 2D缺陷图生成

### 2.1 缺陷数量和位置

```python
k = random.randint(1, self.max_defects)  # 随机缺陷数量：1到max_defects个
x = random.uniform(0.1, 0.9)  # 归一化x坐标，避免边界效应
y = random.uniform(0.1, 0.9)  # 归一化y坐标，避免边界效应
```

**设计原理**：
- 缺陷数量随机化模拟实际检测中的不确定性
- 坐标限制在10%-90%区域内，避免边界伪影
- 使用归一化坐标便于不同图像尺寸的适配

### 2.2 缺陷形状建模

```python
# 像素坐标转换
px = int(x * (self.img_size - 1))
py = int(y * (self.img_size - 1))

# 高斯斑点生成
sigma = random.uniform(1.5, 4.0)  # 随机缺陷尺寸
xv, yv = np.meshgrid(np.arange(self.img_size), np.arange(self.img_size), indexing='xy')
g = np.exp(-((xv-px)**2 + (yv-py)**2) / (2 * sigma**2))
img += g.astype(np.float32)
```

**物理意义**：
- **高斯函数**：模拟缺陷的连续强度分布，符合实际缺陷的模糊边界特征
- **sigma参数**：控制缺陷尺寸，范围1.5-4.0像素，对应不同大小的缺陷
- **叠加原理**：多个缺陷可以重叠，模拟复杂缺陷分布

### 2.3 图像归一化

```python
img = img / (img.max() + 1e-8)  # 归一化到[0,1]
```

**目的**：
- 消除幅度差异，专注于相对强度分布
- 防止除零错误（添加小常数1e-8）
- 为后续神经网络训练提供稳定的输入范围

## 3. 1D超声信号生成

### 3.1 物理映射关系

```python
# 2D位置 → 1D时间延迟
delay = (px + py) / (2 * (self.img_size - 1))
center = int(delay * (self.sig_len - 1))
```

**核心原理**：
- **距离-时间映射**：`(px + py)`近似表示缺陷到探头的距离
- **传播时间**：距离越远，超声回波到达时间越晚
- **线性近似**：简化复杂的声学传播路径为线性关系

**数学解释**：
- 归一化距离：`d_norm = (px + py) / (2 * (img_size - 1))`
- 时间索引：`t_index = d_norm * (sig_len - 1)`
- 这种映射确保了空间位置与时间延迟的一致性

### 3.2 脉冲信号建模

```python
# 脉冲参数
amp = 0.8 + 0.4 * random.random()  # 幅度：0.8-1.2
width = int(6 + 6 * random.random())  # 宽度：6-12个采样点

# 高斯调制的正弦脉冲
idx = np.arange(max(center-4*width, 0), min(center+4*width, self.sig_len))
pulse = (amp * np.exp(-((idx-center)**2) / (2 * (width**2))) * 
         np.sin(2*np.pi*30*(idx-center)/self.sig_len))
```

**信号组成**：
1. **载波**：`sin(2π*30*(t-t0)/T)` - 固定频率30周期/信号长度
2. **包络**：`exp(-(t-t0)²/(2σ²))` - 高斯窗函数
3. **幅度**：随机化的强度因子

**物理意义**：
- **正弦载波**：模拟超声波的振荡特性
- **高斯包络**：模拟阻尼振荡，反映能量耗散
- **有限支撑**：脉冲在时间上局部化，避免全局影响

### 3.3 多缺陷叠加

```python
for (px, py) in defect_positions:
    # 为每个缺陷生成独立脉冲
    # 所有脉冲线性叠加到同一信号中
    sig[idx] += pulse
```

**叠加原理**：
- 线性叠加近似：忽略非线性散射效应
- 独立贡献：每个缺陷产生独立的回波
- 时间分离：不同位置的缺陷产生不同延迟的脉冲

## 4. 噪声模型

### 4.1 高斯白噪声

```python
sig += np.random.normal(scale=self.noise_std, size=sig.shape).astype(np.float32)
```

**特征**：
- **统计特性**：零均值，标准差为noise_std（通常0.02）
- **频谱特性**：白噪声，所有频率成分功率相等
- **时域特性**：独立同分布的随机扰动

**实际意义**：
- 电子噪声：接收电路的热噪声
- 结构噪声：材料晶界散射
- 环境干扰：外部振动和电磁干扰

### 4.2 信噪比控制

```python
# 信号归一化（在添加噪声后）
smax = np.max(np.abs(sig)) + 1e-8
sig = sig / smax
```

**目的**：
- 标准化信号幅度到[-1, 1]范围
- 确保训练过程中的数值稳定性
- 消除不同样本间的幅度差异

## 5. 参数配置

### 5.1 默认参数设置

| 参数 | 默认值 | 含义 | 影响 |
|------|--------|------|------|
| `sig_len` | 1024 | 信号长度 | 时间分辨率 |
| `img_size` | 64 | 图像尺寸 | 空间分辨率 |
| `max_defects` | 3 | 最大缺陷数 | 问题复杂度 |
| `noise_std` | 0.02 | 噪声标准差 | 信噪比 |

### 5.2 参数敏感性分析

**信号长度（sig_len）**：
- 增大：提高时间分辨率，增加计算复杂度
- 减小：降低分辨率，可能丢失细节信息

**图像尺寸（img_size）**：
- 增大：提高空间分辨率，增加目标复杂度
- 减小：简化问题，加快训练速度

**缺陷数量（max_defects）**：
- 增大：提高问题复杂度，增加模型学习难度
- 减小：简化任务，便于模型收敛

**噪声水平（noise_std）**：
- 增大：提高鲁棒性要求，降低信噪比
- 减小：简化信号，但可能过拟合

## 6. 物理假设与限制

### 6.1 简化假设

1. **线性传播**：忽略非线性声学效应
2. **均匀介质**：假设声速恒定
3. **理想脉冲**：忽略频散和衰减
4. **点缺陷近似**：缺陷尺寸相对较小
5. **单次散射**：忽略多次反射

### 6.2 模型限制

1. **几何简化**：实际超声路径更复杂
2. **频率单一**：实际应用中频率范围更广
3. **材料特性**：忽略弹性模量等材料参数
4. **波型单一**：只考虑纵波，忽略横波

### 6.3 与实际应用的差距

**简化之处**：
- 声束聚焦效应
- 近场/远场特性
- 界面反射和透射
- 衰减和散射损失
- 复杂缺陷形状

**保留特征**：
- 时间延迟与距离关系
- 脉冲回波基本形式
- 多缺陷叠加效应
- 噪声污染特性

## 7. 数据质量评估

### 7.1 信号质量指标

1. **信噪比（SNR）**：signal_power / noise_power
2. **脉冲幅度**：peak_amplitude / background_level
3. **时间分辨率**：pulse_width / sampling_interval
4. **频谱纯度**：carrier_frequency_concentration

### 7.2 图像质量指标

1. **缺陷对比度**：defect_intensity / background_intensity
2. **空间分布**：defect_position_statistics
3. **尺寸分布**：sigma_value_distribution
4. **叠加程度**：overlap_ratio

### 7.3 映射一致性

1. **位置对应性**：spatial_position ↔ temporal_delay
2. **强度对应性**：defect_intensity ↔ pulse_amplitude
3. **数量对应性**：defect_count ↔ pulse_count

## 8. 应用建议

### 8.1 模型训练

1. **数据预处理**：考虑额外的标准化步骤
2. **损失函数**：针对稀疏目标设计专门损失
3. **网络架构**：考虑时频域特征提取
4. **正则化**：防止过拟合到简化的映射关系

### 8.2 评估指标

1. **像素级精度**：传统分割指标
2. **缺陷级召回**：检测到的缺陷比例
3. **位置误差**：预测位置与真实位置的偏差
4. **形状相似性**：缺陷形状的匹配程度

### 8.3 扩展方向

1. **复杂缺陷**：非圆形、多连通区域
2. **变参数**：材料特性、声速变化
3. **多模态**：结合A扫、B扫、C扫
4. **实际数据**：逐步过渡到真实超声数据

## 9. 总结

ToyUSDataset提供了一个简化但物理上合理的超声检测数据模型，它：

1. **保持物理直觉**：遵循基本的声学传播原理
2. **控制复杂度**：通过参数调节问题难度
3. **便于理解**：清晰的生成过程和参数含义
4. **适合研究**：为算法验证提供可控环境

虽然相比真实应用有所简化，但该模型为跨模态学习算法的开发和验证提供了良好的起点。通过逐步增加复杂性，可以桥接理论研究与实际应用的差距。
